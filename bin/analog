#!/bin/bash
# Wrapper script for analog that sets the LOGLIB environment variable
# and launches the log program in analog mode (not diglog mode)
# This ensures the program can find its configuration files and loads analog.cnf
CHIPMUNK_DIR="$(cd "$(dirname "$0")/.." && pwd)"
export LOGLIB="${CHIPMUNK_DIR}/log/lib"
export CHIPMUNK_MODE=analog

# Handle help options (check for --help or standalone -h, but not -h with argument)
if [ "$1" = "--help" ] || ([ "$1" = "-h" ] && [ -z "$2" ]); then
    echo "Analog Circuit Simulator - Chipmunk Tools"
    echo ""
    echo "Usage:"
    echo "  ./bin/analog [options] [circuit_file.lgf]"
    echo ""
    echo "Options:"
    echo "  -h, --help    Show this help message"
    echo "  -c <file>     Specify configuration file (default: analog.cnf)"
    echo "  -v            Vanilla LOG mode (no CNF file)"
    echo "  -x <display>  Specify X display name"
    echo "  -h <dir>      Specify home directory (use --help for help)"
    echo ""
    echo "Examples:"
    echo "  ./bin/analog                           # Start with lesson1.lgf (for beginners)"
    echo "  ./bin/analog log/lib/lesson1.lgf       # Open a specific circuit file"
    echo "  ./bin/analog -c log/lib/mos_example.cnf # Use custom configuration"
    echo ""
    echo "For more information, see: https://john-lazzaro.github.io/chipmunk/document/log/index.html"
    exit 0
fi

# Process arguments to handle paths correctly after cd to log/lib
declare -a ARGS=()
for arg in "$@"; do
    # Check if this looks like a file path
    if [ -f "$arg" ]; then
        # Get just the filename, assuming files should be in log/lib
        ARGS+=("$(basename "$arg")")
    else
        # Keep other arguments as-is (like -v, -x, etc.)
        ARGS+=("$arg")
    fi
done

# Change to log/lib directory so relative paths in config files work
cd "${CHIPMUNK_DIR}/log/lib"

# If no arguments provided, open lesson1.lgf for first-time users
if [ $# -eq 0 ]; then
    exec "${CHIPMUNK_DIR}/bin/diglog" -c analog.cnf lesson1.lgf
else
    # Use -c option to explicitly load analog.cnf configuration
    exec "${CHIPMUNK_DIR}/bin/diglog" -c analog.cnf "${ARGS[@]}"
fi
